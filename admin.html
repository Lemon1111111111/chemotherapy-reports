<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ’¼ Tableau de Bord Administrateur</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navbar">
            <div class="navbar-brand" style="position: relative;">
                ğŸ‘¨â€ğŸ’¼ Tableau de Bord Administrateur
                <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
            </div>
            <div class="navbar-user">
                <span id="userName">Administrateur</span>
                <button class="btn btn-danger" id="logoutBtn" style="width: auto; padding: 8px 20px;">ğŸšª DÃ©connexion</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="card" style="text-align: center; padding: 20px;">
                <h3 style="color: #667eea; font-size: 40px; margin: 0;" id="totalIncidents">0</h3>
                <p style="color: #718096; margin-top: 10px;">Total des rapports</p>
            </div>
            <div class="card" style="text-align: center; padding: 20px;">
                <h3 style="color: #f59e0b; font-size: 40px; margin: 0;" id="pendingIncidents">0</h3>
                <p style="color: #718096; margin-top: 10px;">En attente</p>
            </div>
            <div class="card" style="text-align: center; padding: 20px;">
                <h3 style="color: #10b981; font-size: 40px; margin: 0;" id="resolvedIncidents">0</h3>
                <p style="color: #718096; margin-top: 10px;">RÃ©solus</p>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ Tous les Rapports</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <select class="form-select" id="filterStatus" style="width: auto; min-width: 200px;">
                    <option value="">Tous les statuts</option>
                    <option value="pending">En attente</option>
                    <option value="reviewed">ExaminÃ©</option>
                    <option value="resolved">RÃ©solu</option>
                </select>
                <select class="form-select" id="filterService" style="width: auto; min-width: 200px;">
                    <option value="">Tous les services</option>
                    <option value="oncology">Oncologie</option>
                    <option value="hematology">HÃ©matologie</option>
                    <option value="pediatric">PÃ©diatrie</option>
                </select>
                <button class="btn btn-primary" id="refreshBtn" style="width: auto; padding: 10px 25px;">ğŸ”„ Actualiser</button>
            </div>

            <div id="alertMessage" class="alert hidden"></div>
            <div class="spinner show" id="loadingSpinner"></div>

            <div id="reportsContainer" class="hidden">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ“… Date</th>
                                <th>ğŸ‘¤ DÃ©clarant</th>
                                <th>ğŸ¥ Service</th>
                                <th>ğŸ’Š MÃ©dicament</th>
                                <th>ğŸ’‰ Dosage</th>
                                <th>ğŸ­ Labo</th>
                                <th>ğŸ“Š Statut</th>
                                <th>âš™ï¸ Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="noReportsMessage" class="hidden" style="text-align: center; padding: 40px;">
                <h3 style="color: #718096;">ğŸ“‹ Aucun rapport</h3>
            </div>
        </div>
    </div>

    <div id="statusModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card" style="max-width: 400px; margin: 20px;">
            <h3>Modifier le statut du rapport</h3>
            <div class="form-group">
                <label class="form-label">Nouveau statut</label>
                <select class="form-select" id="newStatus">
                    <option value="pending">En attente</option>
                    <option value="reviewed">ExaminÃ©</option>
                    <option value="resolved">RÃ©solu</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" id="confirmStatusBtn">Confirmer</button>
                <button class="btn btn-secondary" onclick="document.getElementById('statusModal').style.display='none'">Annuler</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm'

        const SUPABASE_URL = 'https://tewlugshhfcgkujgovjb.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRld2x1Z3NoaGZjZ2t1amdvdmpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjU5NTAsImV4cCI6MjA4MDg0MTk1MH0.ECW1RQ1tJveR0vc3R297nvG-jvCwKqmkCUaFHUEK2hc'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

        console.log('âœ… Admin page loaded')

        const user = JSON.parse(localStorage.getItem('user'))
        if (!user || user.role !== 'admin') {
            alert('âŒ AccÃ¨s refusÃ©')
            window.location.href = 'index.html'
        }

        document.getElementById('userName').textContent = user.name

        const elements = {
            loading: document.getElementById('loadingSpinner'),
            container: document.getElementById('reportsContainer'),
            noMsg: document.getElementById('noReportsMessage'),
            tableBody: document.getElementById('reportsTableBody'),
            alert: document.getElementById('alertMessage'),
            filterStatus: document.getElementById('filterStatus'),
            filterService: document.getElementById('filterService'),
            badge: document.getElementById('notificationBadge')
        }

        let currentIncidentId = null
        let allIncidents = []
        let lastCount = 0

        function showAlert(msg, type) {
            elements.alert.textContent = msg
            elements.alert.className = 'alert alert-' + type
            elements.alert.classList.remove('hidden')
            window.scrollTo({ top: 0, behavior: 'smooth' })
            setTimeout(() => elements.alert.classList.add('hidden'), 5000)
        }

        function playSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUKnk7bltHwU7k9nyzn0uBSd+yPLmjD4JGGu98OWmUQ0MW6vo7K5aFgxDo+Hzv3AhBS+F0fDgizsIHm7A8+mpVhELTKXh8bllHAU+lt7x1YU2Byh/zPDjkUALFF+16Oyqa1gOQ6Li8r1wIwUshM/x3I4+CBlquvDlnE4MDlCp5O24ax4FOpPY8sx8LQUmfcjy44w+CRhrvfDlplENDFur6OyuWhYMQ6Ph8r9wIQUvhdHw4Is7CB5uwPPpqVYRC0yl4fG5ZRwFPpbe8dWFNgcof8zw45FAAxFdtOjsrGlYD0Ok4vK9cSMELYTP8d6OPggZarry5JxODA5QqeTtuG0dBTqT2PLNfC0FJn3I8uSMPgkYa73w5aVRDQxbq+jsrlsWC0Kj4fK+cCEFL4TQ8d+LOwcebrzu6ahVEQtMpeHxuWUcBT6W3vHVhTYHKH/M8OORQAsUXrTo66xpWA9DpOLyvXAiBCyDzvHejz4IGWq68+OcTgwOUKnk7bhtHQU6k9jzzXwtBSZ9yPLkjD4JGGu98OWlUQ0MW6vn7K5bFgtCo+HyvnAhBS+E0PHfizwHHm687umhVRELTKXh8bllHAU+lt7x1YU2Byh/zPDjkUALFF+16Oysa1cPQ6Tj8r1xIwQshM7y3o4+CBlquvPjnE4MDlCp5O24bR0FOpPY8sx8LQUmfcny5Iw+CRhrvfDlpVENDFur5+yuWhYLQqPh8r5wIQUvhNDx34s8Bx5uvO7poVURC0yl4fG5ZRwFPpbe8daFNwcnf83w45FABBFetejsrGlYD0Ok4vK9cSMELITO8t6OPgcZa7ry45xODA5QqeTtuG0dBTqT2PLMfC0FJn3J8uSMPgkYa73w5aVRDAxbq+jrrlsWC0Kj4fK+cCEFL4TQ8N+LOwcebrzu6aFVEQtMpeHxuWYcBT6V3vHWhTYHKH/M8OOSPwsUXrXo66xpWA9DpOPyvXAiBC2EzvLejz4HGWu68+OcTgwOUKnk7LhuHQU6k9jyzHwtBSZ9yPPkjD4JGGq98OWlUQ0MW6vo7K5aFgtCo+HyvnEhBS+E0fDgizwHHm+97umhVRIMTKTi8bllHAU+ld3x1oU2Byh/zPDjkT8LFF+16Oysa1gPQ6Pj8r1wIgQthc7y3o8+BxlquvPjnE4MDlCp5Oy4bR0FOpLY8sx8LQUmfcny5Iw+CRhqvfDlpVENDFur6OyuWhYLQqLi8r5wIQUvhNHw34s8Bx5vve7poVUSC0yk4vG5ZRwFPZXe8daFNgcof8zw45E/CxRftejsrGtYD0Oj4/K9cCIELYXO8t6PPgcZarry5JxODA5QqeTsuG0eBTqS2PLLfC0FJn3J8+SMPgkYar3w5aVRDQxbq+jrrlsWC0Ki4fK+cCEFL4TQ8d+LPAceb73u6aFVEQtMpOLxuWUcBT2W3vHWhTYHKH/M8OOSP')
                audio.play().catch(() => {})
            } catch(e) {}
        }

        function showNotif(count) {
            if (count > 0) {
                elements.badge.textContent = count
                elements.badge.style.display = 'flex'
            } else {
                elements.badge.style.display = 'none'
            }
        }

        function getService(s) {
            const n = { 'oncology': 'Oncologie', 'hematology': 'HÃ©matologie', 'pediatric': 'PÃ©diatrie' }
            return n[s] || s
        }

        function getStatus(s) {
            const st = {
                'pending': { text: 'En attente', class: 'status-pending' },
                'reviewed': { text: 'ExaminÃ©', class: 'status-reviewed' },
                'resolved': { text: 'RÃ©solu', class: 'status-resolved' }
            }
            return st[s] || { text: s, class: 'status-pending' }
        }

        function formatDate(d) {
            return new Date(d).toLocaleDateString('fr-FR', { 
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            })
        }

        function updateStats(inc) {
            const total = inc.length
            const pending = inc.filter(i => i.status === 'pending').length
            const resolved = inc.filter(i => i.status === 'resolved').length
            
            document.getElementById('totalIncidents').textContent = total
            document.getElementById('pendingIncidents').textContent = pending
            document.getElementById('resolvedIncidents').textContent = resolved
        }

        async function loadReports() {
            try {
                elements.loading.classList.add('show')
                
                const { data, error } = await supabase
                    .from('incidents')
                    .select('*, users (full_name, email)')
                    .order('created_at', { ascending: false })

                if (error) throw error

                allIncidents = data || []
                elements.loading.classList.remove('show')

                if (allIncidents.length === 0) {
                    elements.noMsg.classList.remove('hidden')
                    elements.container.classList.add('hidden')
                    return
                }

                updateStats(allIncidents)
                displayReports(allIncidents)

            } catch (error) {
                elements.loading.classList.remove('show')
                console.error('Error:', error)
                showAlert('Erreur: ' + error.message, 'danger')
            }
        }

        function displayReports(inc) {
            if (inc.length === 0) {
                elements.noMsg.classList.remove('hidden')
                elements.container.classList.add('hidden')
                return
            }

            elements.noMsg.classList.add('hidden')
            elements.container.classList.remove('hidden')
            
            elements.tableBody.innerHTML = inc.map(i => {
                const st = getStatus(i.status)
                return '<tr><td>' + formatDate(i.incident_time) + '</td><td><strong>' + (i.users?.full_name || 'Inconnu') + '</strong><br><small>' + (i.users?.email || '') + '</small></td><td>' + getService(i.service) + '</td><td><strong>' + i.drug_name + '</strong><br><small>' + i.drug_number + '</small></td><td>' + (i.dosage || '-') + '</td><td>' + (i.laboratory || '-') + '</td><td><span class="status-badge ' + st.class + '">' + st.text + '</span></td><td><button class="btn btn-primary view-btn" data-id="' + i.id + '" style="padding:6px 12px;font-size:13px;width:auto;margin-bottom:5px">ğŸ‘ï¸ Voir</button><button class="btn btn-success mod-btn" data-id="' + i.id + '" data-status="' + i.status + '" style="padding:6px 12px;font-size:13px;width:auto">ğŸ”„ Modifier</button></td></tr>'
            }).join('')

            document.querySelectorAll('.view-btn').forEach(b => {
                b.onclick = (e) => {
                    e.stopPropagation()
                    showDetails(b.getAttribute('data-id'))
                }
            })

            document.querySelectorAll('.mod-btn').forEach(b => {
                b.onclick = (e) => {
                    e.stopPropagation()
                    changeStatus(b.getAttribute('data-id'), b.getAttribute('data-status'))
                }
            })
        }

        function showDetails(id) {
            const i = allIncidents.find(x => x.id === id)
            if (!i) return

            const m = document.createElement('div')
            m.id = 'detMod'
            m.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;justify-content:center;align-items:center'
            
            m.innerHTML = '<div class="card" style="max-width:700px;margin:20px;max-height:90vh;overflow-y:auto"><div style="display:flex;justify-content:space-between;margin-bottom:20px"><h3>ğŸ“‹ DÃ©tails</h3><button class="cls" style="background:none;border:none;font-size:24px;cursor:pointer;color:#718096">âœ•</button></div><div><p><strong>ğŸ‘¤ DÃ©clarant:</strong> ' + (i.users?.full_name || 'Inconnu') + '</p><p><strong>ğŸ“§ Email:</strong> ' + (i.users?.email || '-') + '</p><p><strong>ğŸ¥ Service:</strong> ' + getService(i.service) + '</p><p><strong>ğŸ’Š MÃ©dicament (DCI):</strong> ' + i.drug_name + '</p><p><strong>ğŸ’‰ Dosage:</strong> ' + (i.dosage || '-') + '</p><p><strong>ğŸ”¢ NÂ° lot:</strong> ' + i.drug_number + '</p><p><strong>ğŸ­ Labo:</strong> ' + (i.laboratory || '-') + '</p><p><strong>ğŸ“… PÃ©remption:</strong> ' + (i.expiry_date ? new Date(i.expiry_date).toLocaleDateString('fr-FR') : '-') + '</p><p><strong>ğŸ• Date incident:</strong> ' + formatDate(i.incident_time) + '</p><p><strong>ğŸ“ Description:</strong> ' + (i.incident_description || '-') + '</p><p><strong>ğŸ›¡ï¸ EPI:</strong><br>' + (i.wearing_gloves?'âœ…':'âŒ') + ' Gants<br>' + (i.wearing_gown?'âœ…':'âŒ') + ' Blouse<br>' + (i.wearing_cap?'âœ…':'âŒ') + ' Calot<br>' + (i.wearing_apron?'âœ…':'âŒ') + ' Masque<br>' + (i.wearing_shoe_covers?'âœ…':'âŒ') + ' Lunettes</p><p><strong>ğŸ“Š Statut:</strong> <span class="status-badge ' + getStatus(i.status).class + '">' + getStatus(i.status).text + '</span></p>' + (i.incident_image_url ? '<p><strong>ğŸ“· Photo:</strong><br><img src="' + i.incident_image_url + '" style="max-width:100%;border-radius:10px"></p>' : '') + '</div><div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-success mds" style="width:auto;padding:10px 20px">ğŸ”„ Modifier statut</button><button class="btn btn-secondary cls2" style="width:auto;padding:10px 20px">Fermer</button></div></div>'
            
            document.body.appendChild(m)
            
            m.querySelector('.cls').onclick = () => m.remove()
            m.querySelector('.cls2').onclick = () => m.remove()
            m.onclick = (e) => { if(e.target.id==='detMod') m.remove() }
            m.querySelector('.mds').onclick = () => { m.remove(); changeStatus(i.id, i.status) }
            m.querySelector('.prt').onclick = () => printReport(i)
        }

        function changeStatus(id, curr) {
            currentIncidentId = id
            document.getElementById('newStatus').value = curr
            document.getElementById('statusModal').style.display = 'flex'
        }

        function applyFilters() {
            let f = allIncidents
            if (elements.filterStatus.value) f = f.filter(i => i.status === elements.filterStatus.value)
            if (elements.filterService.value) f = f.filter(i => i.service === elements.filterService.value)
            displayReports(f)
        }

        document.getElementById('confirmStatusBtn').onclick = async () => {
            try {
                const { error } = await supabase.from('incidents').update({ status: document.getElementById('newStatus').value }).eq('id', currentIncidentId)
                if (error) throw error
                document.getElementById('statusModal').style.display = 'none'
                showAlert('âœ… Statut mis Ã  jour', 'success')
                loadReports()
            } catch (e) {
                showAlert('âŒ Erreur: ' + e.message, 'danger')
            }
        }

        elements.filterStatus.onchange = applyFilters
        elements.filterService.onchange = applyFilters
        
        document.getElementById('refreshBtn').onclick = () => {
            elements.filterStatus.value = ''
            elements.filterService.value = ''
            showNotif(0)
            loadReports()
        }
        
        document.getElementById('logoutBtn').onclick = async () => {
            await supabase.auth.signOut()
            localStorage.removeItem('user')
            window.location.href = 'index.html'
        }

        async function checkNew() {
            try {
                const { data } = await supabase.from('incidents').select('id').order('created_at', { ascending: false })
                
                if (data && lastCount > 0 && data.length > lastCount) {
                    const n = data.length - lastCount
                    showNotif(n)
                    playSound()
                    showAlert('ğŸ”” ' + n + ' nouveau(x) rapport(s)!', 'info')
                    
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Nouveau rapport', { body: n + ' rapport(s) en attente' })
                    }
                }
                
                if (data) lastCount = data.length
            } catch(e) {}
        }

        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission()
        }

        loadReports().then(() => {
            lastCount = allIncidents.length
            setInterval(checkNew, 30000)
            console.log('ğŸ”” Notifications ON')
        })
      
    </script>
</body>
</html>